<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Bruce&#39;s Blog</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://osgnu.com/"/>
  <updated>2016-06-02T12:50:44.724Z</updated>
  <id>http://osgnu.com/</id>
  
  <author>
    <name>Bruce Zheng</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>压力测试涉及的主要调试参数</title>
    <link href="http://osgnu.com/2016/06/02/options/"/>
    <id>http://osgnu.com/2016/06/02/options/</id>
    <published>2016-06-02T12:36:53.000Z</published>
    <updated>2016-06-02T12:50:44.724Z</updated>
    
    <content type="html">&lt;h1 id=&quot;压力测试的主要调试参数&quot;&gt;&lt;a href=&quot;#压力测试的主要调试参数&quot; class=&quot;headerlink&quot; title=&quot;压力测试的主要调试参数&quot;&gt;&lt;/a&gt;压力测试的主要调试参数&lt;/h1&gt;&lt;h2 id=&quot;一、Linux系统内核参数&quot;&gt;&lt;a href=&quot;#一、Linux系统内核参数&quot; class=&quot;headerlink&quot; title=&quot;一、Linux系统内核参数&quot;&gt;&lt;/a&gt;一、Linux系统内核参数&lt;/h2&gt;&lt;h3 id=&quot;1、-etc-sysctl-conf文件常用参数&quot;&gt;&lt;a href=&quot;#1、-etc-sysctl-conf文件常用参数&quot; class=&quot;headerlink&quot; title=&quot;1、/etc/sysctl.conf文件常用参数&quot;&gt;&lt;/a&gt;1、&lt;code&gt;/etc/sysctl.conf&lt;/code&gt;文件常用参数&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;net.core.netdev_max_backlog = 32768&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 允许送到队列的数据包的最大数目&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.core.rmem_max  = 8388608&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# SOCKET读缓存区大小&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.core.wmem_max  = 8388608&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# SOCKET写缓存区大小&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.core.somaxconn   = 32768&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 系统中每一个端口最大的监听队列的长度&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.core.rmem_max = 16777216&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 最大socket读buffer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.ip_local_port_range = 1024 65000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 允许系统打开的端口范围&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_fin_timeout  = 30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# TIME_WAIT2进入CLOSED的等待时间&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_keepalive_time = 1200&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# TCP发送keepalive消息的时间&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_timestamps = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_synack_retries = 2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_syn_retries = 2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_synack_retries = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 内核放弃连接之前发送SYN+ACK包的数量&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_syn_retries =1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 内核放弃建立连接之前发送SYN包的数量&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_max_tw_buckets =6000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 控制TIME_WAIT的最大数量timewait的数量，默认是180000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_tw_recycle = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# TCP连接中TIME-WAIT套接字的快速回收。默认为0，表示关闭&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_tw_reuse = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 允许将TIME-WAIT套接字重新用于新的TCP连接。默认为0，表示关闭&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_mem = 94500000 915000000 927000000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_max_orphans = 3276800&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_max_syn_backlog = 65536&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多等待连接的网络连接数&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.file-max = 65535&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 系统可打开的文件数&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.nr_open  = 65535&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# fs.file-max的值不要超过fs.nr_open的值&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sysctl -p&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 使sysctl.conf文件的修改生效&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;2、-etc-security-limits-conf文件常用参数&quot;&gt;&lt;a href=&quot;#2、-etc-security-limits-conf文件常用参数&quot; class=&quot;headerlink&quot; title=&quot;2、/etc/security/limits.conf文件常用参数&quot;&gt;&lt;/a&gt;2、&lt;code&gt;/etc/security/limits.conf&lt;/code&gt;文件常用参数&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;在文件最末尾添加&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* soft nofile 65535&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* hard nofile 65535&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;查看是否生效&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# ulimit -a&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;手动修改（重启后失效）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# ulimit -n 65535&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;二、Nginx主要调试参数&quot;&gt;&lt;a href=&quot;#二、Nginx主要调试参数&quot; class=&quot;headerlink&quot; title=&quot;二、Nginx主要调试参数&quot;&gt;&lt;/a&gt;二、Nginx主要调试参数&lt;/h2&gt;&lt;h3 id=&quot;1、主模块参数&quot;&gt;&lt;a href=&quot;#1、主模块参数&quot; class=&quot;headerlink&quot; title=&quot;1、主模块参数&quot;&gt;&lt;/a&gt;1、主模块参数&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;worker_processes = 8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 按照CPU核心数量的设置&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;worker_rlimit_nofile 65535;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# Nginx进程打开文件描述符最大数量&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;use epoll;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 使用epoll事件模型&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;worker_connections = 102400&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 每个进程的最大连接数&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;2、HTTP模块参数&quot;&gt;&lt;a href=&quot;#2、HTTP模块参数&quot; class=&quot;headerlink&quot; title=&quot;2、HTTP模块参数&quot;&gt;&lt;/a&gt;2、HTTP模块参数&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;keepalive_timeout 60;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# keepalive超时时间。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;client_body_buffer_size 64K;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 客户端请求内容的缓冲区大小。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;client_header_buffer_size 8k;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 客户端请求头部的缓冲区大小，可以根据系统的分页大小来设置。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;large_client_header_buffers 4 128k; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;client_max_body_size 8m;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 客户端请求内容的最大值。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;open_file_cache max=204800 inactive=30s;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 打开文件的缓存，max指缓存的最大数量，inactive指缓存过期时间。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;open_file_cache_valid 30s;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 检查缓存的有效时间。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;open_file_cache_min_uses 1;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# inactive参数的时间内文件的最少使用次数，如果超过这个值，则保持缓存的打开状态&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;三、Mysql主要调试参数&quot;&gt;&lt;a href=&quot;#三、Mysql主要调试参数&quot; class=&quot;headerlink&quot; title=&quot;三、Mysql主要调试参数&quot;&gt;&lt;/a&gt;三、Mysql主要调试参数&lt;/h2&gt;&lt;p&gt;下面的配置选项可能比较少(8G内存的MySQL)，实际会超过很多人的需要，以后可以根据MySQL的运行状态进行修改&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[mysql]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;port                           = 3306&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket                         = /var/lib/mysql/mysql.sock&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[mysqld]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;user                           = mysql&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;default_storage_engine         = InnoDB&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket                         = /var/lib/	mysql/mysql.sock&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pid_file                       = /var/lib/mysql/mysql.pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;skip_name_resolvekey_buffer_size                = 32M&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;myisam_recover                 = FORCE,BACKUP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;max_allowed_packet             = 16M&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;max_connect_errors             = 1000000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log_bin                        = /var/lib/mysql/mysql-bin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;expire_logs_days               = 7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sync_binlog                    = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;tmp_table_size                 = 32M&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;max_heap_table_size            = 32M&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;query_cache_type               = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;query_cache_size               = 32M&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;max_connections                = 500&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;thread_cache_size              = 50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;open_files_limit               = 65535&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;table_definition_cache         = 1024&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;table_open_cache               = 2048&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;innodb_flush_method            = O_DIRECT&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;innodb_log_files_in_group      = 2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;innodb_log_file_size           = 256M&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;innodb_flush_log_at_trx_commit = 2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;innodb_file_per_table          = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;innodb_buffer_pool_size        = 4G&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log_error                      = /var/log/mysql-error.log&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log_queries_not_using_indexes  = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slow_query_log                 = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slow_query_log_file            = /var/log/mysql-slow.log&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;四、Tomcat主要调试参数&quot;&gt;&lt;a href=&quot;#四、Tomcat主要调试参数&quot; class=&quot;headerlink&quot; title=&quot;四、Tomcat主要调试参数&quot;&gt;&lt;/a&gt;四、Tomcat主要调试参数&lt;/h2&gt;&lt;h3 id=&quot;1、tomcat中server-xml配置Connector标签下-8080-端口修改protocol-quot-org-apache-coyote-http11-Http11NioProtocol-quot-增加如下参数：&quot;&gt;&lt;a href=&quot;#1、tomcat中server-xml配置Connector标签下-8080-端口修改protocol-quot-org-apache-coyote-http11-Http11NioProtocol-quot-增加如下参数：&quot; class=&quot;headerlink&quot; title=&quot;1、tomcat中server.xml配置Connector标签下 8080 端口修改protocol=&amp;quot;org.apache.coyote.http11.Http11NioProtocol&amp;quot;增加如下参数：&quot;&gt;&lt;/a&gt;1、tomcat中server.xml配置&lt;code&gt;Connector&lt;/code&gt;标签下 8080 端口修改&lt;code&gt;protocol=&amp;quot;org.apache.coyote.http11.Http11NioProtocol&amp;quot;&lt;/code&gt;增加如下参数：&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;connectionTimeout=&amp;quot;20000&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;processorCache=&amp;quot;1000&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;acceptCount=&amp;quot;5000&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;acceptorThreadCount=&amp;quot;8&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#根据实际cpu核数配置&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;maxThreads=&amp;quot;2000&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;minSpareThreads=&amp;quot;100&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket.appReadBufSize=&amp;quot;1024&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket.appWriteBufSize=&amp;quot;1024&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket.bufferPool=&amp;quot;1000&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;catalina.sh&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;2、tomcat启动文件，根据实际情况做调整，-XX-NewRatio用于配置老生代与新生代的比例&quot;&gt;&lt;a href=&quot;#2、tomcat启动文件，根据实际情况做调整，-XX-NewRatio用于配置老生代与新生代的比例&quot; class=&quot;headerlink&quot; title=&quot;2、tomcat启动文件，根据实际情况做调整，-XX:NewRatio用于配置老生代与新生代的比例&quot;&gt;&lt;/a&gt;2、tomcat启动文件，根据实际情况做调整，-XX:NewRatio用于配置老生代与新生代的比例&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;增加JAVA_OPTS=&amp;quot;-server -Xms1048m -Xmx3072m -Xss1024K -XX:PermSize=64m -XX:MaxPermSize=128m -XX:NewRatio=4&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;五、硬件负载查看&quot;&gt;&lt;a href=&quot;#五、硬件负载查看&quot; class=&quot;headerlink&quot; title=&quot;五、硬件负载查看&quot;&gt;&lt;/a&gt;五、硬件负载查看&lt;/h2&gt;&lt;p&gt;查看CPU负载情况&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;top&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;查看内存的使用情况&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;free -m&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;查看磁盘IO的情况&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;iostat -kx 2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;查看网络的流量情况&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sar -n DEV 2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
    
    <summary type="html">
    
      关于Linux、Mysql、Nginx、Tomcat环境下的压力测试涉及的主要调试参数记录
    
    </summary>
    
      <category term="调优" scheme="http://osgnu.com/categories/%E8%B0%83%E4%BC%98/"/>
    
      <category term="压力测试" scheme="http://osgnu.com/categories/%E8%B0%83%E4%BC%98/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/"/>
    
    
      <category term="Linux" scheme="http://osgnu.com/tags/Linux/"/>
    
      <category term="Mysql" scheme="http://osgnu.com/tags/Mysql/"/>
    
      <category term="Nginx" scheme="http://osgnu.com/tags/Nginx/"/>
    
      <category term="Tomcat" scheme="http://osgnu.com/tags/Tomcat/"/>
    
      <category term="调优" scheme="http://osgnu.com/tags/%E8%B0%83%E4%BC%98/"/>
    
      <category term="压力测试" scheme="http://osgnu.com/tags/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>如何判断SYN_Flood攻击并处理</title>
    <link href="http://osgnu.com/2016/06/01/syn-flood/"/>
    <id>http://osgnu.com/2016/06/01/syn-flood/</id>
    <published>2016-06-01T14:24:07.000Z</published>
    <updated>2016-06-02T12:47:07.110Z</updated>
    
    <content type="html">&lt;h1 id=&quot;SYN-Flood的诊断和处理&quot;&gt;&lt;a href=&quot;#SYN-Flood的诊断和处理&quot; class=&quot;headerlink&quot; title=&quot;SYN Flood的诊断和处理&quot;&gt;&lt;/a&gt;SYN Flood的诊断和处理&lt;/h1&gt;&lt;h2 id=&quot;SYN-Flood介绍&quot;&gt;&lt;a href=&quot;#SYN-Flood介绍&quot; class=&quot;headerlink&quot; title=&quot;SYN Flood介绍&quot;&gt;&lt;/a&gt;SYN Flood介绍&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;    前段时间网站被攻击多次，其中最猛烈的就是TCP洪水攻击，即SYN Flood。
    SYN Flood是当前最流行的DoS（拒绝服务攻击）与DDoS（分布式拒绝服务攻击）的方式之一，这是一种利用
TCP协议缺陷，发送大量伪造的TCP连接请求，常用假冒的IP或IP号段发来海量的请求连接的第一个握手包（SYN包），
被攻击服务器回应第二个握手包（SYN+ACK包），因为对方是假冒IP，对方永收不到包且不会回应第三个握手包。导致
被攻击服务器保持大量SYN_RECV状态的“半连接”，并且会重试默认5次回应第二个握手包，塞满TCP等待连接队列，资
源耗尽（CPU满负荷或内存不足），让正常的业务请求连接不进来。
    详细的原理，网上有很多介绍，应对办法也很多，但大部分没什么效果，这里介绍我们是如何诊断和应对的。
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;首先谈谈如何诊断&quot;&gt;&lt;a href=&quot;#首先谈谈如何诊断&quot; class=&quot;headerlink&quot; title=&quot;首先谈谈如何诊断&quot;&gt;&lt;/a&gt;首先谈谈如何诊断&lt;/h2&gt;&lt;p&gt;我们看到业务曲线大跌时，检查机器和DNS，发现只是对外的web机响应慢、CPU负载高、ssh登陆慢甚至有些机器登陆不上，检查系统syslog：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;＃ tail -f /var/log/messages&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Apr 18 11:21:56 web5 kernel: possible *SYN flooding* on port 80. Sending cookies.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;检查连接数增多，并且SYN_RECV 连接特别多：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# netstat -n | awk &amp;apos;/^tcp/ &amp;#123;++S[$NF]&amp;#125; END &amp;#123;for(a in S) print a, S[a]&amp;#125;&amp;apos; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;TIME_WAIT 16855&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CLOSE_WAIT 21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SYN_SENT 99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FIN_WAIT1 229&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FIN_WAIT2 113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ESTABLISHED 8358&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*SYN_RECV 48965*&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CLOSING 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LAST_ACK 313&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;根据经验，正常时检查连接数如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# netstat -n | awk &amp;apos;/^tcp/ &amp;#123;++S[$NF]&amp;#125; END &amp;#123;for(a in S) print a, S[a]&amp;#125;&amp;apos; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;TIME_WAIT 42349&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CLOSE_WAIT 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SYN_SENT 4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FIN_WAIT1 298&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FIN_WAIT2 33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ESTABLISHED 12775&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*SYN_RECV 259*&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CLOSING 6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LAST_ACK 432&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以上就是TCP洪水攻击的两大特征。执行netstat -na &amp;gt; 指定文件，保留罪证。&lt;/p&gt;
&lt;h2 id=&quot;应急处理&quot;&gt;&lt;a href=&quot;#应急处理&quot; class=&quot;headerlink&quot; title=&quot;应急处理&quot;&gt;&lt;/a&gt;应急处理&lt;/h2&gt;&lt;p&gt;根据netstat查看到的对方IP特征：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# netstat -na | grep SYN_RECV | more
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;利用iptables临时封掉最大嫌疑攻击的IP或IP号段，例如对方假冒173.*.*.*段来攻击，短期禁用173.*.*.*这个大号段（要确认小心不要封掉自己的本地IP了！）&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# iptables -A INPUT -s  173.0.0.0/8  -p tcp  –dport 80 -j DROP
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;再分析刚才保留的罪证，分析业务，用iptables解封正常173.&lt;em&gt;.&lt;/em&gt;.*号段内正常的ip和子网段。这样应急处理很容易误伤，甚至可能因为封错了导致ssh登陆不了服务器，并不是理想方式。&lt;/p&gt;
&lt;h2 id=&quot;使用F5挡攻击&quot;&gt;&lt;a href=&quot;#使用F5挡攻击&quot; class=&quot;headerlink&quot; title=&quot;使用F5挡攻击&quot;&gt;&lt;/a&gt;使用F5挡攻击&lt;/h2&gt;&lt;p&gt;应急处理毕竟太被动，因为本机房的F5比较空闲，运维利用F5来挡攻击，采用方式：让客户端先和F5三次握手，连接建立之后F5才转发到后端业务服务器。后来被攻击时F5上看到的现象：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1. 连接数比平时多了500万，攻击停止后恢复。
2. 修改F5上我们业务的VS模式后，F5的CPU消耗比平时多7%，攻击停止后恢复。
3. 用F5挡效果明显，后来因攻击无效后，用户很少来攻击了，毕竟攻击也是有成本的。
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;调整系统参数挡攻击&quot;&gt;&lt;a href=&quot;#调整系统参数挡攻击&quot; class=&quot;headerlink&quot; title=&quot;调整系统参数挡攻击&quot;&gt;&lt;/a&gt;调整系统参数挡攻击&lt;/h2&gt;&lt;p&gt;没有F5这种高级且昂贵的设备怎么办？我测试过以下参数组合能明显减小影响，准备以后不用F5抗攻击。&lt;/p&gt;
&lt;p&gt;第一个参数&lt;code&gt;tcp_synack_retries = 0&lt;/code&gt;是关键，表示回应第二个握手包（SYN+ACK包）给客户端IP后，如果收不到第三次握手包（ACK包）后，不进行重试，加快回收“半连接”，不要耗光资源。&lt;/p&gt;
&lt;p&gt;不修改这个参数，模拟攻击，10秒后被攻击的80端口即无法服务，机器难以ssh登录； 用命令&lt;code&gt;netstat -na |grep SYN_RECV&lt;/code&gt;检测“半连接”hold住180秒；&lt;/p&gt;
&lt;p&gt;修改这个参数为0，再模拟攻击，持续10分钟后被攻击的80端口都可以服务，响应稍慢些而已，只是ssh有时也登录不上；检测“半连接”只hold住3秒即释放掉。&lt;/p&gt;
&lt;p&gt;修改这个参数为0的副作用：网络状况很差时，如果对方没收到第二个握手包，可能连接服务器失败，但对于一般网站，用户刷新一次页面即可。这些可以在高峰期或网络状况不好时tcpdump抓包验证下。&lt;/p&gt;
&lt;p&gt;根据以前的抓包经验，这种情况很少，但为了保险起见，可以只在被tcp洪水攻击时临时启用这个参数。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;tcp_synack_retries&lt;/code&gt;默认为5，表示重发5次，每次等待30~40秒，即“半连接”默认hold住大约180秒。&lt;strong&gt;详细解释：&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;The tcp_synack_retries setting tells the kernel how many times to retransmit the SYN,
ACK reply to an SYN request. In other words, this tells the system how many times to 
try to establish a passive TCP connection that was started by another host.This 
variable takes an integer value, but should under no circumstances be larger than 255 
for the same reasons as for the tcp_syn_retries variable. Each retransmission will 
take aproximately 30-40 seconds. The default value of the tcp_synack_retries variable 
is 5, and hence the default timeout of passive TCP connections is aproximately 180 
seconds.
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;之所以可以把&lt;code&gt;tcp_synack_retries&lt;/code&gt;改为0，因为客户端还有&lt;code&gt;tcp_syn_retries&lt;/code&gt;参数，默认是5，即使服务器端没有重发SYN+ACK包，客户端也会重发SYN握手包。&lt;strong&gt;详细解释：&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;The tcp_syn_retries variable tells the kernel how many times to try to retransmit the 
initial SYN packet for an active TCP connection attempt.This variable takes an integer 
value, but should not be set higher than 255 since eachretransmission will consume 
huge amounts of time as well as some amounts of bandwidth. Eachconnection 
retransmission takes aproximately 30-40 seconds. The default setting is 5, which would 
lead to an aproximate of 180 seconds delay before the connection times out.
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;第二个参数&lt;code&gt;net.ipv4.tcp_max_syn_backlog = 200000&lt;/code&gt;也重要，具体多少数值受限于内存。&lt;br&gt;以下配置，第一段参数是最重要的，第二段参数是辅助的，其余参数是其他作用的：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# vi /etc/sysctl.conf
&lt;/code&gt;&lt;/pre&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# 最关键参数，默认为5，修改为0 表示不要重发&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_synack_retries = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 半连接队列长度&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_max_syn_backlog = 200000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 系统允许的文件句柄的最大数目，因为连接需要占用文件句柄&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.file-max = 819200&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 用来应对突发的大并发connect 请求&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.core.somaxconn = 65536&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 最大的TCP 数据接收缓冲（字节）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.core.rmem_max = 1024123000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 最大的TCP 数据发送缓冲（字节）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.core.wmem_max = 16777216&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 网络设备接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.core.netdev_max_backlog = 165536&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 本机主动连接其他机器时的端口分配范围&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.ip_local_port_range = 10000 65535&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# ……省略其它……&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使配置生效：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# sysctl -p
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;注意，以下参数面对外网时，不要打开。因为副作用很明显，具体原因请google，如果已打开请显式改为0，然后执行sysctl -p关闭。因为经过试验，大量&lt;code&gt;TIME_WAIT&lt;/code&gt;状态的连接对系统没太大影响：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# 当出现 半连接 队列溢出时向对方发送syncookies，调大 半连接 队列后没必要&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_syncookies = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# TIME_WAIT状态的连接重用功能&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_tw_reuse = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 时间戳选项，与前面net.ipv4.tcp_tw_reuse参数配合&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_timestamps = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# TIME_WAIT状态的连接回收功能&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.tcp_tw_recycle = 0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;为了处理大量连接，还需改大另一个参数：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# vi /etc/security/limits.conf
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;在底下添加一行表示允许每个用户都最大可打开409600个文件句柄（包括连接）：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;*                –       nofile          409600
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;参考资料&quot;&gt;&lt;a href=&quot;#参考资料&quot; class=&quot;headerlink&quot; title=&quot;参考资料&quot;&gt;&lt;/a&gt;参考资料&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;文件句柄不要超过系统限制/usr/include/linux/fs.h，相关链接：&lt;a href=&quot;http://blog.yufeng.info/archives/1380&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.yufeng.info/archives/1380&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# define NR_OPEN (1024*1024)     /* Absolute upper limit on fd num */&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;内核参数详细解释：&lt;a href=&quot;http://www.frozentux.net/ipsysctl-tutorial/chunkyhtml/tcpvariables.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.frozentux.net/ipsysctl-tutorial/chunkyhtml/tcpvariables.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;结束语&quot;&gt;&lt;a href=&quot;#结束语&quot; class=&quot;headerlink&quot; title=&quot;结束语&quot;&gt;&lt;/a&gt;结束语&lt;/h2&gt;&lt;p&gt;TCP洪水攻击还没完美解决方案，只能短时间阻挡或者缓解，希望对你有帮助。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      关于TCP_IP洪水流攻击(SYN_Flood)的诊断和处理
    
    </summary>
    
      <category term="安全" scheme="http://osgnu.com/categories/%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="Syn Flood" scheme="http://osgnu.com/tags/Syn-Flood/"/>
    
      <category term="洪水流" scheme="http://osgnu.com/tags/%E6%B4%AA%E6%B0%B4%E6%B5%81/"/>
    
      <category term="攻击" scheme="http://osgnu.com/tags/%E6%94%BB%E5%87%BB/"/>
    
      <category term="安全" scheme="http://osgnu.com/tags/%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
</feed>
